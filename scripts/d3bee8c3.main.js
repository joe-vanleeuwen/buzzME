function overlay(){var a=document.getElementById("modal");a.style.visibility="visible"==a.style.visibility?"hidden":"visible"}function saveMessage(){var a=new MessageClass;a.set("alias",currentUser.get("alias")),a.set("message",$("#usermsg").val()),a.set("username",currentUser.get("username"));var b=moment().format();a.set("time",b);var c="users-message";template(a,c),scrollToBottom(),a.save(null,{success:function(){},error:function(a,b){console.log(b.description)}})}function continuousFetch(){handle=setInterval(function(){var a=new Parse.Query(MessageClass);a.greaterThan("createdAt",allMessages.at(allMessages.length-1).createdAt),a.find({success:function(a){allMessages.add(a),display(allMessages),changeTitleNum(newMessageSound(a,scrolltoBottomIf()))},error:function(){console.log("you blew it")}}),getTimeDiff(),userIsLoggedIn()},3e3)}function userIsLoggedIn(){currentLoggedInUsers.fetch({success:function(a){$(".active-users ul").html("");var b;a.each(function(a){b=a.get("active")?"user-is-active":"user-is-active not-active",showActiveUsers(a,b)})}})}function getTimeDiff(){Math.abs(userActive.diff())>12e4&&currentUser.get("active")?(currentUser.set("active",!1),currentUser.save()):Math.abs(userActive.diff())<12e4&&currentUser.get("active")===!1&&(currentUser.set("active",!0),currentUser.save())}function showActiveUsers(a,b){$(".active-users ul").append('<li><div class="'+b+'"></div>'+a.get("alias")+"</li>")}function scrolltoBottomIf(){var a=getDiff();return a-$(".chatbox-enclosure").scrollTop()<=50?(scrollToBottom(),!1):!0}function scrollToBottom(){$(".chatbox-enclosure").scrollTop($(".chatbox-enclosure")[0].scrollHeight)}function scrollToPosition(a){$(".chatbox-enclosure").scrollTop(a)}function getDiff(){return $("#chatbox").outerHeight(!0)-$(".chatbox-enclosure").height()}function newMessageSound(a,b){var c=0;if(b||!currentUser.get("active")){var d=new Audio("../sound-effects/floop.wav");a.forEach(function(a){a.get("alias")!==currentUser.get("alias")&&(d.play(),popUpMessage(a),c+=1)})}else c=0;return c}function popUpMessage(a){$(".pop-up-name").text(a.get("alias")),$(".pop-up-message").text(a.get("message")),$(".pop-up").removeClass("show-pop-up"),$(".pop-up").addClass("show-pop-up")}function changeTitleNum(a){var b,c=$("title").text(),d=$("#chatbox").outerHeight(!0)-$(".chatbox-enclosure").height();d-$(".chatbox-enclosure").scrollTop()>50||!currentUser.get("active")?c.length>6?b=parseInt(c.slice(7,c.length-1)):(b=0,a>0&&$("title").text("buzzME("+(a+b)+")")):$("title").text("buzzME")}function display(a){$("#chatbox").html(""),a.each(function(a){template(a,ifUser(a))})}function ifUser(a){return a.get("username")===currentUser.get("username")?"users-message":""}function template(a,b){var c=moment(a.get("time"));$("#chatbox").append('<div class="chat-message '+b+'"><div class="name '+b+'">'+a.get("alias")+'</div><div class="message">'+a.get("message")+'</div><div class="time-stamp">'+c.fromNow()+"</div></div>")}function pagination(a){var b=new Parse.Query(MessageClass);b.limit(a),b.descending("createdAt"),allMessages.length&&b.lessThan("createdAt",allMessages.at(0).createdAt),b.find({success:function(a){var b=getDiff(),c=[];allMessages.each(function(a){c.push(a)}),allMessages.reset(),a.forEach(function(a){c.unshift(a)}),allMessages.add(c),display(allMessages),scrollToPosition(getDiff()-b)},error:function(){console.log("you blew it")}})}function signUp(){var a=new Parse.User;a.set("username",$(".sign-up-name").val()),a.set("password",$(".sign-up-password").val()),a.set("email",$(".sign-up-email").val()),a.set("alias",$(".sign-up-alias").val()),a.set("loggedIn",!0),a.set("active",!0),a.signUp(null,{success:function(a){overlay(),clearInputs(),currentUser=Parse.User.current();var b="user-is-active";showActiveUsers(a,b),modalOffExample()},error:function(a,b){alert("Error: "+b.code+" "+b.message)}})}function logIn(){Parse.User.logIn($(".log-in-name").val(),$(".log-in-password").val(),{success:function(){overlay(),clearInputs(),currentUser=Parse.User.current(),showAlias();var a="user-is-active";showActiveUsers(currentUser,a),currentUser.set("loggedIn",!0),currentUser.set("active",!0),currentUser.save(null,{success:function(){modalOffExample()}})},error:function(a,b){101===b.code?alert("Username or Password are invalid."):console.log("Error: "+b.code+" "+b.message)}})}function clickSignUp(){$(".sign-up").click(function(){signUp()})}function clickLogIn(){$(".log-in").click(function(){logIn()})}function clickLogOut(){$(".logout").click(function(){currentUser.set("loggedIn",!1),currentUser.set("active",!1),currentUser.save(null,{success:function(){logOut(),overlay()},error:function(a){console.log(a.description)}})})}function logOut(){$(".active-users ul").html(""),Parse.User.logOut(),currentUser=Parse.User.current(),clearInterval(handle)}function showAlias(){$(".current-user").text(currentUser.get("alias"))}function modalOffExample(){pagination(25),continuousFetch()}function clearInputs(){$("#modal input").each(function(){$(this).val("")})}Parse.initialize("VZqbbMNR30PJJai3TJoF9YpzeNfvOOf3NZ4G9bLe","pVp5vCCYofq0RNoQBVLt8VscOYlSqmQJCNRMjUce");var MessageClass=Parse.Object.extend("Message"),MessageCollectionClass=Parse.Collection.extend({model:MessageClass}),CurrentUserCollectionClass=Parse.Collection.extend({model:Parse.User,query:new Parse.Query(Parse.User).equalTo("loggedIn",!0)}),allMessages=new MessageCollectionClass,currentLoggedInUsers=new CurrentUserCollectionClass,currentUser=null,handle,userActive=moment();$("document").ready(function(){clickSignUp(),clickLogIn(),clickLogOut(),$("#submitmsg").click(function(a){a.preventDefault(),saveMessage(),$("#usermsg").val(""),userActive=moment()}),$("#usermsg").keydown(function(a){13===a.which&&(a.preventDefault(),saveMessage(),$(this).val(""),userActive=moment())}),$(".change-alias").keydown(function(a){13===a.which&&(a.preventDefault(),currentUser.set("alias",$(this).val()),showAlias(),currentUser.save(),$(this).val(""),userActive=moment())}),$(".chatbox-enclosure").scroll(function(){userActive=moment(),$(".chatbox-enclosure").scrollTop()<2&&pagination(25)}),$("html").click(function(){userActive=moment()}),overlay()});